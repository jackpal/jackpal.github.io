<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="GrammerJack"/><link rel="canonical" href="https://jackpal.github.io/posts/2009/11/A_Multi-threaded_Go_Raytracer"/><meta name="twitter:url" content="https://jackpal.github.io/posts/2009/11/A_Multi-threaded_Go_Raytracer"/><meta name="og:url" content="https://jackpal.github.io/posts/2009/11/A_Multi-threaded_Go_Raytracer"/><title>A Multi-threaded Go Raytracer | GrammerJack</title><meta name="twitter:title" content="A Multi-threaded Go Raytracer | GrammerJack"/><meta name="og:title" content="A Multi-threaded Go Raytracer | GrammerJack"/><meta name="description" content="I ported a tiny multi-threaded raytracer example from F# to Go."/><meta name="twitter:description" content="I ported a tiny multi-threaded raytracer example from F# to Go."/><meta name="og:description" content="I ported a tiny multi-threaded raytracer example from F# to Go."/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to GrammerJack"/><meta name="twitter:image" content="https://jackpal.github.io/trace.png"/><meta name="og:image" content="https://jackpal.github.io/trace.png"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">GrammerJack</a><nav><ul><li><a href="/about">About</a></li><li><a class="selected" href="/posts">My posts</a></li></ul></nav></div></header><div class="wrapper"><article><div class="content"><h1>A Multi-threaded Go Raytracer</h1><img src="trace.png" alt="Recursive Spheres Ray Trace"/><p>Above is the output of the raytracer. Below is a diagnostic mode showing which goroutines raytraced which section of the screen. Each goroutine has its own color to outline the pixels it traces:</p><img src="cells.png" alt="Diagnostic Mode"/><p>I wrote a simple multi-threaded ray tracer in Google's new "go" language. It's an adaptation of <a href="http://www.ffconsultancy.com/languages/ray_tracer/comparison.html">Flying Frog Consultancy's Raytracer</a>.</p><p>It runs single-threaded about 1/2 the speed of a comparable C++ version. I guess the C++ version benefits from a more optimizing compiler and the ability to inline small functions.</p><p>Compared to ordinary C/C++, the Go version was easier to multithread.</p><p>On my dual-core Macbook Pro I get an 1.80x speedup when running with GOMAXPROCS &gt; 1:</p><pre><code><div class="highlight"><span></span><span class="err">$</span> <span class="n">GOMAXPROCS</span><span class="p">=</span><span class="mi">1</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">gotrace</span>

<span class="o">**</span><span class="mf">1.52</span><span class="o">**</span> <span class="n">real</span> <span class="mf">1.50</span> <span class="n">user</span> <span class="mf">0.01</span> <span class="n">sys</span>

<span class="err">$</span> <span class="n">GOMAXPROCS</span><span class="p">=</span><span class="mi">2</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">gotrace</span>

<span class="o">**</span><span class="mf">0.82</span><span class="o">**</span> <span class="n">real</span> <span class="mf">1.50</span> <span class="n">user</span> <span class="mf">0.01</span> <span class="n">sys</span>

<span class="err">$</span> <span class="n">GOMAXPROCS</span><span class="p">=</span><span class="mi">3</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">gotrace</span>

<span class="o">**</span><span class="mf">0.81</span><span class="o">**</span> <span class="n">real</span> <span class="mf">1.50</span> <span class="n">user</span> <span class="mf">0.01</span> <span class="n">sys</span>
</div></code></pre><p>On an eight-core, 16 Hyperthread HP Z600 running Ubuntu 9.10, (with the source code changed to use 16 goroutines instead of the default 8 goroutines) I get a 5.8x speedup:</p><pre><code><div class="highlight"><span></span><span class="err">$</span> <span class="n">GOMAXPROCS</span><span class="p">=</span><span class="mi">1</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">gotrace</span>

<span class="mf">1.05</span><span class="n">user</span> <span class="mf">0.01</span><span class="n">system</span> <span class="mi">0</span><span class="p">:</span><span class="mf">01.06</span><span class="n">elapsed</span> <span class="mi">99</span><span class="o">%</span><span class="n">CPU</span> <span class="p">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="o">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">0</span><span class="n">maxresident</span><span class="p">)</span><span class="n">k</span>

<span class="mi">0</span><span class="n">inputs</span><span class="o">+</span><span class="mi">1544</span><span class="n">outputs</span> <span class="p">(</span><span class="mi">0</span><span class="n">major</span><span class="o">+</span><span class="mi">2128</span><span class="n">minor</span><span class="p">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>

<span class="err">$</span> <span class="n">GOMAXPROCS</span><span class="p">=</span><span class="mi">16</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">gotrace</span>

<span class="mf">1.32</span><span class="n">user</span> <span class="mf">0.00</span><span class="n">system</span> <span class="mi">0</span><span class="p">:</span><span class="mf">00.18</span><span class="n">elapsed</span> <span class="mi">702</span><span class="o">%</span><span class="n">CPU</span> <span class="p">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="o">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">0</span><span class="n">maxresident</span><span class="p">)</span><span class="n">k</span>

<span class="mi">0</span><span class="n">inputs</span><span class="o">+</span><span class="mi">1544</span><span class="n">outputs</span> <span class="p">(</span><span class="mi">0</span><span class="n">major</span><span class="o">+</span><span class="mi">2190</span><span class="n">minor</span><span class="p">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>
</div></code></pre><p>Source code <a href="http://jack.palevich.googlepages.com/gotracer.zip">gotracer.zip</a></p></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/go">go</a></li><li><a href="/tags/3d">3d</a></li></ul></article></div><footer><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>